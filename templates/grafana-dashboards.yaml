{{- $ns := .Values.global.namespace }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provisioning
  namespace: {{ $ns }}
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'SRE Pack'
        orgId: 1
        folder: 'SRE'
        type: file
        disableDeletion: false
        allowUiUpdates: true
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: {{ $ns }}
data:
  sre-application-overview.json: |
    {
      "uid": "sre-app-overview",
      "title": "SRE – Application Overview",
      "time": { "from": "now-6h", "to": "now" },
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "tags": ["sre","app","prometheus","loki"],
      "templating": {
        "list": [
          { "type": "datasource", "name": "PROM", "query": "prometheus", "current": { "text": "Prometheus", "value": "Prometheus" } },
          { "type": "datasource", "name": "LOKI", "query": "loki", "current": { "text": "Loki", "value": "Loki" } }
        ]
      },
      "panels": [
        {
          "type": "stat",
          "title": "Prometheus up (self)",
          "gridPos": { "h": 6, "w": 8, "x": 0, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(up{job=\"prometheus\"})" } ]
        },
        {
          "type": "stat",
          "title": "Alertmanager up",
          "gridPos": { "h": 6, "w": 8, "x": 8, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(up{job=\"alertmanager\"})" } ]
        },
        {
          "type": "logs",
          "title": "Loki logs (demo)",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 6 },
          "datasource": "Loki",
          "targets": [ { "expr": "{cluster=\"local\"}" } ]
        }
      ]
    }

  sre-prometheus-targets.json: |
    {
      "uid": "sre-prom-targets",
      "title": "SRE – Prometheus Targets",
      "time": { "from": "now-6h", "to": "now" },
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "tags": ["sre","prometheus"],
      "panels": [
        {
          "type": "table",
          "title": "Targets (up metric)",
          "gridPos": { "h": 12, "w": 24, "x": 0, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "up" } ]
        }
      ]
    }

  sre-loki-logs-overview.json: |
    {
      "uid": "sre-loki-logs",
      "title": "SRE – Loki Logs Overview",
      "time": { "from": "now-6h", "to": "now" },
      "schemaVersion": 38,
      "version": 1,
      "refresh": "10s",
      "tags": ["sre","loki","logs"],
      "panels": [
        {
          "type": "logs",
          "title": "Live logs",
          "gridPos": { "h": 12, "w": 24, "x": 0, "y": 0 },
          "datasource": "Loki",
          "targets": [ { "expr": "{}" } ]
        }
      ]
    }

  sre-postgres-overview.json: |
    {
      "uid": "sre-postgres",
      "title": "SRE – Postgres Overview",
      "time": { "from": "now-6h", "to": "now" },
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "tags": ["sre","postgres","prometheus"],
      "panels": [
        {
          "type": "stat",
          "title": "pg_up",
          "gridPos": { "h": 6, "w": 8, "x": 0, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(pg_up)" } ]
        },
        {
          "type": "timeSeries",
          "title": "Active connections",
          "gridPos": { "h": 6, "w": 16, "x": 8, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(pg_stat_activity_count{state=\"active\"})" } ]
        },
        {
          "type": "timeSeries",
          "title": "Commits & rollbacks",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 6 },
          "datasource": "Prometheus",
          "targets": [
            { "expr": "sum(rate(pg_stat_database_xact_commit[5m]))", "legendFormat": "commit" },
            { "expr": "sum(rate(pg_stat_database_xact_rollback[5m]))", "legendFormat": "rollback" }
          ]
        }
      ]
    }

---

{{- $ns := .Values.global.namespace }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: {{ $ns }}
data:
  sre-nginx-overview.json: |
    {
      "uid": "sre-nginx",
      "title": "SRE – NGINX Overview",
      "time": { "from": "now-6h", "to": "now" },
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "tags": ["sre","nginx","prometheus"],
      "panels": [
        {
          "type": "stat",
          "title": "Active connections",
          "gridPos": { "h": 6, "w": 8, "x": 0, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(nginx_connections_active)" } ]
        },
        {
          "type": "timeSeries",
          "title": "Requests rate (req/s)",
          "gridPos": { "h": 6, "w": 16, "x": 8, "y": 0 },
          "datasource": "Prometheus",
          "targets": [ { "expr": "sum(rate(nginx_http_requests_total[5m]))" } ]
        },
        {
          "type": "timeSeries",
          "title": "Connections state",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 6 },
          "datasource": "Prometheus",
          "targets": [
            { "expr": "sum(nginx_connections_reading)", "legendFormat": "reading" },
            { "expr": "sum(nginx_connections_writing)", "legendFormat": "writing" },
            { "expr": "sum(nginx_connections_waiting)", "legendFormat": "waiting" }
          ]
        }
      ]
    }

